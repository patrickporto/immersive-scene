name: Flatpak Build

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: flatpak-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-flatpak:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            flatpak \
            flatpak-builder

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install frontend dependencies
        run: npm ci --legacy-peer-deps

      - name: Build Linux binary
        run: npm run tauri build -- --bundles app

      - name: Configure Flatpak runtime
        run: |
          flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          flatpak install -y flathub org.freedesktop.Platform//24.08 org.freedesktop.Sdk//24.08

      - name: Build Flatpak repository
        run: |
          flatpak-builder --force-clean --repo=repo build-dir packaging/flatpak/com.patrickporto.immersive-scene.yml

      - name: Build Flatpak bundle
        run: |
          flatpak build-bundle repo immersive-scene.flatpak com.patrickporto.immersive-scene
          sha256sum immersive-scene.flatpak > checksums-flatpak.txt

      - name: Upload Flatpak artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-flatpak
          path: immersive-scene.flatpak
          if-no-files-found: error

      - name: Upload Flatpak checksum
        uses: actions/upload-artifact@v4
        with:
          name: checksums-linux-flatpak
          path: checksums-flatpak.txt
          if-no-files-found: error
